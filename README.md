# Тестовая задача (Работа с бд)
**C# .NET Framework console app (test task)**

**Содержание**  
1. [Общие требования к выполнению задания](#requirements)
2. [Реализация](#realization)
   - [Используемые технологии](#technologies_used)
   - [Общий принцип реализации](#principle_of_implementation)
3. [Тестовые задачи](#test_tasks)
   - [Задача №1](#task_1)
     - [Описание](#task_1_description)
     - [Реализация](#task_1_realization)
     - [Команда](#task_1_command)
   - [Задача №2](#task_2)
     - [Описание](#task_2_description)
     - [Реализация](#task_2_realization)
     - [Команда](#task_2_command)
   - [Задача №3](#task_3)
     - [Описание](#task_3_description)
     - [Реализация](#task_3_realization)
     - [Модификация](#task_3_modification)
     - [Команда](#task_3_command)
   - [Задача №4](#task_4)
     - [Описание](#task_4_description)
     - [Реализация](#task_4_realization)
     - [Команда](#task_4_command)
   - [Задача №5](#task_5)
     - [Описание](#task_5_description)
     - [Реализация](#task_5_realization)
     - [Команда](#task_5_command)
   - [Задача №6](#task_6)
     - [Описание](#task_6_description)
     - [Реализация](#task_6_realization)
     - [Команда](#task_6_command)

## <a id="requirements">Общие требования к выполнению задания</a>
Общие требования:  
- Написать приложение, которое будет запускаться из консоли с параметрами. Первый параметр, передаваемый при запуске, выбирает режим работы приложения, соответствующий пункту задания. По ходу задания будут примеры запуска приложения;  
- Для ФИО использовать английский язык. Решать проблему с отображением русского языка в консоли, если возникает, не нужно. Приложение должно подключаться к базе данных;  
- В качестве СУБД можно использовать любую SQL СУБД или MongoDB;  
- В разработке приложения обязательно применять объектно-ориентированный подход;  
- В качестве среды разработки можете использовать любой известный вам объектно-ориентированный язык программирования.

## <a id="realization">Реализация</a>
### <a id="technologies_used">Используемые технологии</a>

**Среда разработки**: *Visual Studio 2022*  
**Фреймворк**: *.NET Framework C#*  
**База данных**: *PostgreSQL*  
**Дополнительные средства**: *Entity Framework Core (ORM)*, *NPGSQL*, *Dependency injection* от Microsoft  

### <a id="principle_of_implementation">Общий принцип реализации</a>  
В основе разработанного приложения лежит DI-контейнер (контейнер зависимостей), который позволяет гибко использовать реализованные классы и зависимости.  

Доступ к базе данных(PostgreSQL) осуществляется через (ORM) Entity Framework Core, позволяя нам создать БД и манипулировать её содержимым не используя язык запросов SQL. Также для сравнения времени взаимодействия с бд, использовалось подключение через NPGSQL и команды (COPY), что даёт быстрое взаимодействие с бд при помощи потоков загрузки и выгрузки данных.  

Само приложение по сути представляет собой две логические части:  
- Задач(Директория: Tasks), которые выполняются в зависимости от входного параметра аргумента консоли. За вызов соответствующей задачи отвечает менеджер(TaskManager) представляющий собой словарь команд;  
- "API"(Реализованный всеми остальными директориями), которое представлено реализациями сервисов, хранилищ и утилит, для обработки сотрудников, получаемыми через DI-контейнер.  
## <a id="test_tasks">Тестовые задачи</a>  
### <a id="task_1">Задача №1</a>  
#### <a id="task_1_description">Описание</a>  
Создание таблицы с полями справочника сотрудников, представляющими "Фамилию Имя Отчество", "дату рождения", "пол"  
Пример запуска приложения:  
>*myApp 1*  

К примеру, для java:  
>*java myApp.class 1* или *java myApp.jar 1*

#### <a id="task_1_realization">Реализация</a>  
Так как мы используем ADO.NET Entity Framework, то создание таблицы как и базы данных, можно возложить на EF Core через метод EnsureCreated().
#### <a id="task_1_command">Команда</a>  
>*cmd> TestTaskWithDB.exe 1*

### <a id="task_2">Задача №2</a>  
#### <a id="task_2_description">Описание</a>  
Создание записи справочника сотрудников.  

Для работы с данными создать класс и создавать объекты. При вводе создавать новый объект класса, с введенными пользователем данными.При генерации строчек в базу создавать объект и его отправлять в базу/формировать строчку для отправки нескольких строк в БД.  
У объекта должны быть методы, которые:  
- отправляют объект в БД;
- рассчитывают возраст (полных лет).  

Пример запуска во 2 режиме:
>*myApp 2 "Ivanov Petr Sergeevich" 2009-07-12 Male*
#### <a id="task_2_realization">Реализация</a>  
Так как мы используем ADO.NET Entity Framework, то сотрудники на стороне БД представляются сущностями EmployeeEntity, а на стороне бизнес-логики моделями Employee. Возраст сотрудника возвращается из модели Employee, через свойство Age от сегодняшнего дня (если ДР. сегодня, то год прибавляется).  

Для отправки в бд используется единичная отправка сотрудника или сразу группы сотрудников через перегруженный метод одной транзакцией (внутренняя функциональность EF - AddRange).
#### <a id="task_2_command">Команда</a>  
Добавление одного сотрудника:  
>*cmd> TestTaskWithDB.exe 2 "Ivanov Petr Sergeevich" 2009-07-12 Male*  

Добавление нескольких сотрудников:  
>*cmd> TestTaskWithDB.exe 2 "Employee1" 1999-07-12 Male "Employee2" 2009-07-12 Female*  

### <a id="task_3">Задача №3</a>  
#### <a id="task_3_description">Описание</a>  
Вывод всех строк справочника сотрудников, с уникальным значением ФИО+дата, отсортированным по ФИО. Вывести ФИО, Дату рождения, пол, кол-во полных лет.  
Пример запуска приложения:  
>myApp 3
#### <a id="task_3_realization">Реализация</a>  
Для выполнения данного запроса было решено добалять в бд напрямую функцию, которая находит уникальных пользователей по параметру "ФИО+дата", также можно не добавлять функцию, а вызывать запрос на прямую через метод EF Core -> FromSqlRaw.
#### <a id="task_3_modification">Модификация</a>  
После команды **"*myApp* {Command}"** можно указать дополнительную команду "+", что добавит перед выполнением запроса тестовые записи в бд с уникальными "ФИО+дата".  

Пример:  
>*cmd> TestTaskWithDB.exe 3 +*

#### <a id="task_3_command">Команда</a>  
>*cmd> TestTaskWithDB.exe 3 [+]*

### <a id="task_4">Задача №4</a>  
#### <a id="task_4_description">Описание</a>  
Заполнение автоматически 1000000 строк справочника сотрудников. Распределение пола в них должно быть относительно равномерным, начальной буквы ФИО также. Добавить заполнение автоматически 100 строк в которых пол мужской, и Фамилия начинается с "F".  

У класса необходимо создать метод, который пакетно отправляет данные в БД, принимая массив объектов.  

Пример запуска приложения:  
>myApp 4

#### <a id="task_4_realization">Реализация</a>  
Так как мы используем ADO.NET Entity Framework, то в нём есть пакетная отправка группы сотрудников через метод AddRange() и вызова SaveChanges().  

Также реализована пакетная отправка сотрудников при помощи NPGSQL(команды COPY), что даёт нам максимальную скорость загрузки данных в бд (реализация INpgsqlRepository -> InsertBatch).

#### <a id="task_4_command">Команда</a>  
>*cmd> TestTaskWithDB.exe 4*

### <a id="task_5">Задача №5</a>  
#### <a id="task_5_description">Описание</a>  
Результат выборки из таблицы по критерию: пол мужской, Фамилия начинается с "F". Сделать замер времени выполнения.  

Пример запуска приложения:  
>myApp 5  

Вывод приложения должен содержать время. Заполнить это время в отчете по выполнению тестового задания.

#### <a id="task_5_realization">Реализация</a>  
Так как мы используем ADO.NET Entity Framework, то для замеров времени выполнения запрососв будем получать значения несколькими способами:  
- Через EF Core LINQ (может кэшироваться);  
- Sql запросом через EF Core FromSqlRaw(нет кеширования);  
- Через NPGSQL(команды COPY), что даёт нам максимальную скорость выгрузки данных из бд (реализация INpgsqlRepository -> GetData).
#### <a id="task_5_command">Команда</a>  
>*cmd> TestTaskWithDB.exe 5*

### <a id="task_6">Задача №6</a>  
#### <a id="task_6_description">Описание</a>  
Произвести оптимизацию базы данных или запросов к базе для ускорения выполнения пункта 5. Убедиться, что время исполнения уменьшилось. Объяснить смысл произведенных действий. Предоставить результаты замера времени выполнения до и после оптимизации.
#### <a id="task_6_realization">Реализация</a>  
Основное решение добавление индекса по столбцам выборки:  
```SQL
		CREATE INDEX IF NOT EXISTS employees_name_gender 
		ON public."Employees" ("FullName","Gender");
```
Дополнительные рекомендации: так как мы используем ADO.NET Entity Framework он является узким местом для повышения производительности выполнения запросов. Его можно заменить на Drapper (низкоуровневая ORM) с NPGSQL командой (COPY), что даст нам высокий прирост к скорости. Результаты замеров представлены в логе без индекса и с индексом соответственно. Сравнения EF Core запросов с кешированием и без него, а также запросы через NPGSQL командой (COPY).

#### <a id="task_6_command">Команда</a>  
>*cmd> TestTaskWithDB.exe 6*